<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | Gen Z</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="product-page">
  <header class="p-header">
    <div class="p-header-container">
      <div class="brand">
        <button id="langBtn" class="lang-toggle" title="Language">üåê</button>
        <span id="brandSep" class="brand-sep">|</span>
        <h2 class="site-title"><a href="index.html#home" class="logo">Gen Z</a></h2>
      </div>
      <nav class="nav">
        <ul>
          <li><a id="navHome" href="index.html#home">Home</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
  <div class="left">
    <img id="pImage" class="product-img" src="" alt="">
    <div id="pThumbs" class="thumbs" style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap"></div>
  </div>

  <div class="right">
    <h2 id="pName"></h2>
    <div id="pDesc" style="width: 90%;"></div>

<br>

    <h3 id="lblColor">Color:</h3>
    <div class="colors" id="pColors"></div>
    
    <label for="pSize"><strong id="lblSize">Size:</strong></label><select id="pSize" style="width: 20%;"></select>

    <div class="buttons">
          <h3 id="pPrice"></h3>
      <button id="addToCart" class="btn" style="display:none;">Add to Cart üõí</button>
      <button id="buyNow" class="btn">Buy Now</button>
    </div>
    </div>
</div>


  <footer>
    <p>Made with ‚ù§Ô∏è by Gen Z</p>
  </footer>

  <!-- Lightbox for product images -->
  <div class="lightbox" id="imgLightbox" aria-hidden="true">
    <div class="lightbox-content">
      <img id="lbImage" src="" alt="product preview"/>
      <button class="lb-close" id="lbClose" aria-label="Close">‚úï</button>
      <button class="lb-arrow lb-prev" id="lbPrev" aria-label="Previous">‚Äπ</button>
      <button class="lb-arrow lb-next" id="lbNext" aria-label="Next">‚Ä∫</button>
    </div>
  </div>

  <!-- ===== Modal ===== -->
   
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h3>Complete Your Order</h3>
      <p><strong>Product:</strong> <span id="modalProductName"></span></p>
      <p><strong>Price:</strong> <span id="modalProductPrice"></span> EGP</p>
      <p><strong>Color:</strong> <span id="modalColor"></span></p>

      <label>Full Name</label><br>
      <input type="text" id="custName" placeholder="Enter your name" required><br>

      <label>Phone Number</label><br>
      <input type="tel" id="custPhone" placeholder="01XXXXXXXXX" required><br>

      <label>Governorate</label><br>
      <input list="govList" id="custGov" placeholder="Type or select governorate" required>
      <datalist id="govList">
        <option value="Cairo">
        <option value="Giza">
        <option value="Alexandria">
        <option value="Port Said">
        <option value="Suez">
        <option value="Damietta">
        <option value="Dakahlia">
        <option value="Sharqia">
        <option value="Qalyubia">
        <option value="Kafr El Sheikh">
        <option value="Gharbia">
        <option value="Monufia">
        <option value="Beheira">
        <option value="Ismailia">
        <option value="Fayoum">
        <option value="Minya">
        <option value="Assiut">
        <option value="Sohag">
        <option value="Qena">
        <option value="Luxor">
        <option value="Aswan">
        <option value="Beni Suef">
        <option value="Red Sea">
        <option value="New Valley">
        <option value="Matrouh">
        <option value="North Sinai">
        <option value="South Sinai">
      </datalist><br>

      <label>City</label><br>
      <input type="text" id="custCity" placeholder="Enter your city" required><br>

      <label>Full Address</label><br>
      <input type="text" id="custAddress" placeholder="Street, building, floor..." required><br>

      <label>Additional info</label><br>
      <input type="text" id="custAdditional" placeholder="..........."><br>

      <p class="total">Shipping: <span id="shippingCost">0</span> EGP</p>
      <p class="total">Total: <span id="totalCost">0</span> EGP</p>

      <button id="confirmOrder" class="btn btn-primary" style="display:block;margin:0 auto;">Confirm Order</button>
    </div>
  </div>

  <script src="product.js"></script>
  <script>
    // ====== I18N (EN/AR) ======
    const I18N = {
      en: {
        back: 'Continue shopping', color: 'Color:', size: 'Size:', add_to_cart: 'Add to Cart üõí', buy_now: 'Buy Now',
        cart: 'Cart', total: 'Total', checkout: 'Checkout', ck_title: 'Complete Your Order', shipping: 'Shipping:', confirm: 'Confirm Order',
        name: 'Full Name', phone: 'Phone', gov: 'Governorate', city: 'City', address: 'Address', addn: 'Additional info (optional)',
        cart_empty: 'Your cart is empty.',
        fill_required: 'Please fill all required fields.', fill_color: 'Please select a color first.',
        added_to_cart: 'üõí Added to cart!', add_failed: 'Failed to add to cart',
        order_success: 'Order placed successfully!', checkout_failed: 'Checkout failed', order_failed: 'Failed to place order',
        product_not_found: 'Product not found.'
      },
      ar: {
        back: 'ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ', color: 'ÿßŸÑŸÑŸàŸÜ:', size: 'ÿßŸÑŸÖŸÇÿßÿ≥:', add_to_cart: 'ÿ£ÿ∂ŸÅ ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ© üõí', buy_now: 'ÿßÿ¥ÿ™ÿ±Ÿä ÿßŸÑÿ¢ŸÜ',
        cart: 'ÿßŸÑÿ≥ŸÑÿ©', total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', checkout: 'ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°', ck_title: 'ÿ£ŸÉŸÖŸÑ ÿ∑ŸÑÿ®ŸÉ', shipping: 'ÿßŸÑÿ¥ÿ≠ŸÜ:', confirm: 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ®',
        name: 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ', phone: 'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ', gov: 'ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ©', city: 'ÿßŸÑŸÖÿØŸäŸÜÿ©', address: 'ÿßŸÑÿπŸÜŸàÿßŸÜ', addn: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)',
        cart_empty: 'ÿ≥ŸÑÿ™ŸÉ ŸÅÿßÿ±ÿ∫ÿ©.',
        fill_required: 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©.', fill_color: 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÑŸàŸÜ ÿ£ŸàŸÑÿßŸã.',
        added_to_cart: 'üõí ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©!', add_failed: 'ŸÅÿ¥ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿßŸÑÿ≥ŸÑÿ©',
        order_success: 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!', checkout_failed: 'ŸÅÿ¥ŸÑ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®', order_failed: 'ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®',
        product_not_found: 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.'
      }
    };
    function getLang(){ return localStorage.getItem('lang') || 'en'; }
    function t(k){ const l=getLang(); return (I18N[l] && I18N[l][k]) || I18N.en[k] || k; }
    function applyTranslations(){
      const l = getLang();
      // Keep page LTR and static layout (no reordering on language change)
      const hc = document.querySelector('.p-header-container');
      const brand = document.querySelector('.p-header-container .brand');
      if (hc){ hc.style.display='flex'; hc.style.alignItems='center'; hc.style.gap='16px'; hc.style.justifyContent='space-between'; }
      if (brand){ brand.style.display='flex'; brand.style.alignItems='center'; brand.style.gap='12px'; }
      const set = (id, txt)=>{ const el=document.getElementById(id); if (el) el.textContent = txt; };
      set('navBack', t('back'));
      set('lblColor', t('color'));
      set('lblSize', t('size'));
      const ac = document.getElementById('addToCart'); if (ac) ac.textContent = t('add_to_cart');
      const bn = document.getElementById('buyNow'); if (bn) bn.textContent = t('buy_now');
      set('cartTitle', t('cart'));
      set('cartTotalLabel', t('total'));
      const co = document.getElementById('cartCheckout'); if (co) co.textContent = t('checkout');
      set('ckTitle', t('ck_title'));
      const ph = (id, key)=>{ const el=document.getElementById(id); if (el) el.setAttribute('placeholder', t(key)); };
      ph('ckName','name'); ph('ckPhone','phone'); ph('ckGov','gov'); ph('ckCity','city'); ph('ckAddress','address'); ph('ckAddition','addn');
      set('ckShippingLabel', t('shipping'));
      set('ckTotalLabel', t('total'));
      const cf = document.getElementById('ckConfirm'); if (cf) cf.textContent = t('confirm');
      const cem = document.getElementById('cartEmptyMsg'); if (cem) cem.textContent = t('cart_empty');
      const nf = document.getElementById('notFoundMsg'); if (nf) nf.textContent = t('product_not_found');
    }
    function setLang(l){ localStorage.setItem('lang', l); applyTranslations(); }
    window.addEventListener('DOMContentLoaded', ()=>{
      // Header scroll opacity effect
      const pHeader = document.querySelector('header.p-header');
      if (pHeader){
        window.addEventListener('scroll', ()=>{
          if (window.scrollY > 10) pHeader.classList.add('scrolled'); else pHeader.classList.remove('scrolled');
        });
      }
      // Language button remains inline next to the separator (no fixed positioning)
      // Build language select menu similar to index
      const langBtn = document.getElementById('langBtn');
      if (langBtn){
        let menu = document.getElementById('langMenu');
        if (!menu){
          menu = document.createElement('div');
          menu.id = 'langMenu';
          menu.style.cssText = 'position:fixed;display:none;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px;box-shadow:0 10px 25px rgba(0,0,0,.12);z-index:1000;';
          menu.innerHTML = '<select id="langSelect" style="padding:6px 8px;border-radius:6px;border:1px solid #e5e7eb"><option value="en">English</option><option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option></select>';
          document.body.appendChild(menu);
        }
        function place(){ const r = langBtn.getBoundingClientRect(); menu.style.left = r.left + 'px'; menu.style.top = (r.bottom + 8) + 'px'; }
        langBtn.addEventListener('click', (e)=>{ e.preventDefault(); place(); const sel = document.getElementById('langSelect'); if (sel) sel.value=getLang(); menu.style.display = (menu.style.display==='none' || !menu.style.display) ? 'block' : 'none'; });
        document.addEventListener('click', (e)=>{ if (e.target===langBtn || menu.contains(e.target)) return; menu.style.display='none'; });
        document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') menu.style.display='none'; });
        document.body.addEventListener('change', (e)=>{ if (e.target && e.target.id==='langSelect'){ setLang(e.target.value); menu.style.display='none'; }});
      }
      applyTranslations();
    });
    function showNotice(key, fallback){
      const modal = document.getElementById('noticeModal');
      const txt = document.getElementById('noticeText');
      if (!modal || !txt) return alert(fallback || key);
      txt.textContent = t(key) || fallback || '';
      modal.style.display = 'flex';
    }
    const params = new URLSearchParams(location.search);
    const productId = params.get('id');
    let product = null;
    const nameEl = document.getElementById('pName');
    const priceEl = document.getElementById('pPrice');
    const imgEl = document.getElementById('pImage');
    const colorsEl = document.getElementById('pColors');
    const descEl = document.getElementById('pDesc');
    let selectedColor = '';
    let imagesArr = [];
    let currentImgIndex = 0;
    let rotTimer = null;
    if (!productId) {
      document.body.innerHTML = '<h2>Product not found.</h2>';
    } else {
      fetch('/api/products/' + encodeURIComponent(productId), { credentials: 'include' })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (!data) throw new Error('not found');
          product = data;
          nameEl.textContent = product.name;
          priceEl.textContent = product.price + ' EGP';
          // Build images array from product.images or comma-separated product.image
          const imgsField = product.images || product.image || '';
          if (Array.isArray(imgsField)) imagesArr = imgsField.filter(Boolean);
          else if (typeof imgsField === 'string' && imgsField.includes(',')) imagesArr = imgsField.split(',').map(s=>s.trim()).filter(Boolean);
          else if (typeof imgsField === 'string' && imgsField.trim()) imagesArr = [imgsField.trim()];
          if (!imagesArr.length) imagesArr = ['https://via.placeholder.com/800x600'];
          // setup smooth transition for main image
          imgEl.style.transition = 'opacity .5s ease, transform .5s ease';
          function setMain(idx){
            if (!imagesArr.length) return;
            const next = (idx + imagesArr.length) % imagesArr.length;
            currentImgIndex = next;
            imgEl.style.opacity = '0';
            imgEl.style.transform = 'scale(0.98)';
            setTimeout(()=>{
              imgEl.src = imagesArr[next];
              imgEl.style.opacity = '1';
              imgEl.style.transform = 'scale(1)';
              
            }, 300);
          }
          // initialize main image
          setMain(0);
          // build thumbnails from second image onwards
          const thumbs = document.getElementById('pThumbs');
          thumbs.innerHTML = '';
          imagesArr.slice(1).forEach((url, i)=>{
            const t = document.createElement('img');
            t.src = url;
            t.alt = '';
            t.style.width = '64px';
            t.style.height = '64px';
            t.style.objectFit = 'cover';
            t.style.borderRadius = '8px';
            t.style.border = '1px solid #eee';
            t.style.cursor = 'pointer';
            t.style.transition = 'opacity .6s ease';
            t.addEventListener('click', ()=>{
              // map thumbnail index (i) to imagesArr index (i+1)
              setMain(i+1);
              restartRotate();
            });
            thumbs.appendChild(t);
          });
          // auto-rotate every 2s between big and the rest
          function startRotate(){
            stopRotate();
            rotTimer = setInterval(()=>{
              // if there are only 1 image, do nothing
              if (imagesArr.length <= 1) return;
              // next index cycles through array
              setMain(currentImgIndex + 1);
            }, 4000);
          }
          function stopRotate(){ if (rotTimer){ clearInterval(rotTimer); rotTimer = null; } }
          function restartRotate(){ stopRotate(); startRotate(); }
          startRotate();
          descEl.textContent = product.desc || 'No description available.';
          colorsEl.innerHTML = '';
          if (product.color) {
            product.color.split(',').forEach(c => {
              const div = document.createElement('div');
              div.className = 'color-circle';
              div.style.background = c.trim();
              div.onclick = () => {
                document.querySelectorAll('.color-circle').forEach(cc => cc.classList.remove('selected'));
                div.classList.add('selected');
                selectedColor = c.trim();
              };
              colorsEl.appendChild(div);
            });
          }
          // Sizes
          const sizeSelect = document.getElementById('pSize');
          sizeSelect.innerHTML = '';
          const sizes = (product.sizes || '').split(',').map(s=>s.trim()).filter(Boolean);
          const defaultSizes = ['L','XL','2XL','3XL'];
          (sizes.length ? sizes : defaultSizes).forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s; sizeSelect.appendChild(opt);
          });
          document.getElementById('addToCart').style.display = 'inline-block';
        })
        .catch(() => { document.body.innerHTML = '<h2 id="notFoundMsg">Product not found.</h2>'; applyTranslations && applyTranslations(); });
    }

    function refreshCartCount(){
      fetch('/api/cart', { credentials: 'include' })
        .then(r => r.json())
        .then(items => {
          const cnt = Array.isArray(items) ? items.reduce((a,i)=>a + (Number(i.quantity)||1), 0) : 0;
          const el = document.getElementById('cartCount');
          if (el) el.textContent = cnt;
        })
        .catch(()=>{
          const el = document.getElementById('cartCount');
          if (el) el.textContent = 0;
        });
    }
    refreshCartCount();

    // Ensure Notice modal exists
    (function ensureNoticeModal(){
      if (document.getElementById('noticeModal')) return;
      const div = document.createElement('div');
      div.innerHTML = `
        <div class="modal" id="noticeModal" style="display:none;align-items:center;justify-content:center;">
          <div class="modal-content" style="max-width:420px;width:92%;text-align:center;">
            <div id="noticeText" style="margin-bottom:12px;font-size:1rem"></div>
            <button id="noticeClose" class="btn-primary">OK</button>
          </div>
        </div>`;
      document.body.appendChild(div);
      document.getElementById('noticeClose').addEventListener('click', ()=>{
        document.getElementById('noticeModal').style.display = 'none';
      });
      window.addEventListener('click', (e)=>{ const m = document.getElementById('noticeModal'); if (e.target === m) m.style.display='none'; });
    })();

    // Create floating cart button (FAB)
    (function createFabCart(){
      if (document.getElementById('openCartLink')) return;
      const fab = document.createElement('button');
      fab.id = 'openCartLink';
      fab.className = 'fab-cart';
      fab.setAttribute('aria-label','Open cart');
      fab.innerHTML = 'üõí<span class="fab-badge" id="cartCount">0</span>';
      document.body.appendChild(fab);
    })();

    // ==== Cart Drawer UI (same behavior as index) ====
    (function ensureCartDrawer(){
      if (document.getElementById('cartDrawer')) return;
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div id="cartOverlay" class="cart-overlay"></div>
        <aside id="cartDrawer" class="cart-drawer">
          <div class="cart-header">
            <strong id="cartTitle">Cart</strong>
            <button id="cartClose" class="cart-close">‚úï</button>
          </div>
          <div id="cartItems" class="cart-items"></div>
          <div class="cart-footer">
            <div class="cart-total"><span id="cartTotalLabel">Total</span><strong><span id="cartTotal">0</span> EGP</strong></div>
            <button id="cartCheckout" class="btn-primary">Checkout</button>
          </div>
        </aside>
        <div class="modal" id="cartCheckoutModal" style="display:none;align-items:center;justify-content:center;">
          <div class="modal-content" style="max-width:520px;width:92%;">
            <div class="cart-header" style="border:none;padding:0 0 10px 0;">
              <h3 id="ckTitle" style="margin:0">Complete Your Order</h3>
              <button id="closeCartModal" class="cart-close">‚úï</button>
            </div>
            <div class="grid">
              <input id="ckName" placeholder="Full Name" />
              <input id="ckPhone" placeholder="Phone" />
              <input id="ckGov" placeholder="Governorate" />
              <input id="ckCity" placeholder="City" />
              <input id="ckAddress" class="full" placeholder="Address" />
              <input id="ckAddition" class="full" placeholder="Additional info (optional)" />
              <div class="full" style="display:flex;gap:10px;align-items:center">
                <label id="ckShippingLabel">Shipping:</label>
                <span id="ckShipVal">0</span> EGP
              </div>
              <div class="full" style="text-align:right;font-weight:600"><span id="ckTotalLabel">Total</span>: <span id="ckTotal">0</span> EGP</div>
              <button id="ckConfirm" class="btn-primary">Confirm Order</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(wrap);
    })();

    const openCartLink = document.getElementById('openCartLink');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartOverlay = document.getElementById('cartOverlay');
    const cartItems = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartClose = document.getElementById('cartClose');
    const cartCheckoutBtn = document.getElementById('cartCheckout');
    const cartCheckoutModal = document.getElementById('cartCheckoutModal');
    const closeCartModalBtn = document.getElementById('closeCartModal');
    const ckTotal = document.getElementById('ckTotal');

    function openCart(){
      cartOverlay.style.display = 'block';
      cartDrawer.style.right = '0';
      const fab = document.getElementById('openCartLink'); if (fab) fab.style.display = 'none';
      loadCartDrawer();
    }
    function closeCart(){
      cartOverlay.style.display = 'none';
      cartDrawer.style.right = '-420px';
      const fab = document.getElementById('openCartLink'); if (fab) fab.style.display = 'flex';
    }
    openCartLink.addEventListener('click', (e)=>{ e.preventDefault(); openCart(); });
    cartOverlay.addEventListener('click', closeCart);
    cartClose.addEventListener('click', closeCart);

    function renderCartDrawer(items){
      if (!Array.isArray(items) || items.length === 0){
        cartItems.innerHTML = '<div style="padding:16px;text-align:center;color:#666" id="cartEmptyMsg">Your cart is empty.</div>';
        cartTotalEl.textContent = '0';
        ckTotal.textContent = '0';
        return;
      }
      let html = '';
      let subtotal = 0;
      items.forEach(it => {
        const price = Number(it.price) || 0;
        const qty = Number(it.quantity) || 1;
        subtotal += price * qty;
        html += `
          <div class=\"cart-row\">
            <img src=\"${it.image || ''}\" alt=\"\"/>
            <div class=\"cart-info\">
              <div class=\"name\">${it.name}</div>
              <div class=\"meta\">
                <span class=\"color-dot\" style=\"background:${it.color || '#ccc'}\"></span>
                ${it.size ? '<span style="margin-inline-start:6px">'+it.size+'</span>' : ''}
              </div>
              <div class=\"price\">${price.toFixed(2)} EGP</div>
            </div>
            <div class=\"qty\">
              <button data-act=\"dec\" data-id=\"${it.id}\">-</button>
              <span>${qty}</span>
              <button data-act=\"inc\" data-id=\"${it.id}\">+</button>
            </div>
          </div>
        `;
      });
      cartItems.innerHTML = html;
      cartTotalEl.textContent = subtotal.toFixed(2);
      // Compute shipping from governorate, similar to Buy Now
      function computeShip(){
        const gov = (document.getElementById('ckGov')?.value || '').trim();
        const upper = ["Minya","Assiut","Sohag","Qena","Luxor","Aswan"];
        if (!gov) return 0;
        return upper.includes(gov) ? 90 : 70;
      }
      const ship = computeShip();
      const sv = document.getElementById('ckShipVal'); if (sv) sv.textContent = String(ship);
      ckTotal.textContent = (subtotal + ship).toFixed(2);

      cartItems.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');
          fetch('/api/cart', { credentials: 'include' })
            .then(r=>r.json()).then(items=>{
              const row = (Array.isArray(items)?items:[]).find(x=> String(x.id)===String(id));
              if (!row) return;
              let newQty = Number(row.quantity)||1;
              newQty = act === 'inc' ? newQty + 1 : newQty - 1;
              if (newQty <= 0){
                fetch('/api/cart/' + encodeURIComponent(id), { method:'DELETE', credentials:'include' })
                  .then(()=>{ loadCartDrawer(); refreshCartCount(); })
                  .catch(()=>{});
              } else {
                fetch('/api/cart/' + encodeURIComponent(id), { method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ quantity: newQty }) })
                  .then(()=>{ loadCartDrawer(); refreshCartCount(); })
                  .catch(()=>{});
              }
            });
        });
      });
    }

    function loadCartDrawer(){
      fetch('/api/cart', { credentials: 'include' })
        .then(r => r.json())
        .then(items => renderCartDrawer(Array.isArray(items)?items:[]))
        .catch(()=> renderCartDrawer([]));
    }

    const ckGovEl = document.getElementById('ckGov');
    ckGovEl.addEventListener('change', ()=>{
      fetch('/api/cart', { credentials: 'include' })
        .then(r=>r.json()).then(items=>{
          const subtotal = (Array.isArray(items)?items:[]).reduce((s,it)=> s + (Number(it.price)||0)*(Number(it.quantity)||1), 0);
          const upper = ["Minya","Assiut","Sohag","Qena","Luxor","Aswan"];
          const gov = (ckGovEl.value||'').trim();
          const ship = gov ? (upper.includes(gov) ? 70 : 50) : 0;
          const sv = document.getElementById('ckShipVal'); if (sv) sv.textContent = String(ship);
          ckTotal.textContent = (subtotal + ship).toFixed(2);
        });
    });

    cartCheckoutBtn.addEventListener('click', ()=>{ cartCheckoutModal.style.display = 'flex'; });
    closeCartModalBtn.addEventListener('click', ()=>{ cartCheckoutModal.style.display = 'none'; });
    window.addEventListener('click', (e)=>{ if (e.target === cartCheckoutModal) cartCheckoutModal.style.display = 'none'; });

    document.getElementById('ckConfirm').addEventListener('click', async ()=>{
      const name = document.getElementById('ckName').value.trim();
      const phone = document.getElementById('ckPhone').value.trim();
      const gov = document.getElementById('ckGov').value.trim();
      const city = document.getElementById('ckCity').value.trim();
      const address = document.getElementById('ckAddress').value.trim();
      const addition = document.getElementById('ckAddition').value.trim();
      const govVal = (document.getElementById('ckGov').value||'').trim();
      const upper = ["Minya","Assiut","Sohag","Qena","Luxor","Aswan"];
      const shipping = govVal ? (upper.includes(govVal) ? 70 : 50) : 0;
      if (!name || !phone || !gov || !city || !address){ showNotice('fill_required','Please fill all required fields.'); return; }
      try {
        const res = await fetch('/api/orders/checkout', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ name, phone, gov, city, address, addition, shipping }) });
        const data = await res.json();
        if (!res.ok){ showNotice('checkout_failed', data.error||'Checkout failed'); return; }
        cartCheckoutModal.style.display = 'none';
        closeCart();
        refreshCartCount();
        showNotice('order_success','Order placed successfully!');
      } catch(e){ showNotice('checkout_failed','Checkout failed'); }
    });

    document.getElementById('addToCart').onclick = () => {
      if (!product || !product.id) return showNotice('product_not_found','Product not found.');
      if (!selectedColor) return showNotice('fill_color','Please select a color first.');
      const size = document.getElementById('pSize').value;
      fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ product_id: product.id, size, color: selectedColor, quantity: 1 })
      }).then(r => r.json()).then(() => { showNotice('added_to_cart','Added to cart!'); refreshCartCount(); })
      .catch(() => showNotice('add_failed','Failed to add to cart'));
    };

    // ===== Modal Logic =====
    const modal = document.getElementById('orderModal');
    const openModal = document.getElementById('buyNow');
    const closeModal = document.getElementById('closeModal');
    const govSelect = document.getElementById('custGov');
    const shippingCostEl = document.getElementById('shippingCost');
    const totalCostEl = document.getElementById('totalCost');

    openModal.onclick = () => {
      if (!selectedColor) { showNotice('fill_color','Please select a color first.'); return; }
      modal.style.display = 'flex';
      document.getElementById('modalProductName').textContent = product.name;
      document.getElementById('modalProductPrice').textContent = product.price;
      document.getElementById('modalColor').textContent = selectedColor;
      updateTotal();
    };

    closeModal.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

    function updateTotal() {
      const upperEgypt = ["Minya", "Assiut", "Sohag", "Qena", "Luxor", "Aswan"];
      const selectedGov = govSelect.value;
      const shipping = upperEgypt.includes(selectedGov) ? 70 : (selectedGov ? 50 : 0);
      const total = Number(product.price) + shipping;
      shippingCostEl.textContent = shipping;
      totalCostEl.textContent = total;
    }

    govSelect.addEventListener('change', updateTotal);

    document.getElementById('confirmOrder').onclick = () => {
    const name = document.getElementById('custName').value;
    const phone = document.getElementById('custPhone').value;
    const gov = govSelect.value;
    const city = document.getElementById('custCity').value;
    const address = document.getElementById('custAddress').value;
    const addition = document.getElementById('custAdditional').value;
    const size = document.getElementById('pSize').value; 

    if (!name || !phone || !gov || !city || !address) { showNotice('fill_required','Please fill all required fields.'); return; }
    const date = new Date().toLocaleString();
    const shipping = Number(shippingCostEl.textContent);
    const total = Number(totalCostEl.textContent);

    const order = {
      product: product ? product.name : '',
      color: selectedColor,
      size,
      name,
      phone,
      gov,
      city,
      address,
      price: Number(product ? product.price : 0),
      shipping,
      total,
      addition,
      date
    };

    fetch('/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(order)
    }).then(r => r.json()).then(res => {
      modal.style.display = 'none';
      showNotice('order_success','Order placed successfully!');
    }).catch(() => showNotice('order_failed','Failed to place order'));
};

    // ===== Product image Lightbox =====
    (function setupLightbox(){
      const lb = document.getElementById('imgLightbox');
      const lbImg = document.getElementById('lbImage');
      const lbClose = document.getElementById('lbClose');
      const lbPrev = document.getElementById('lbPrev');
      const lbNext = document.getElementById('lbNext');
      let current = 0;

      function show(idx){
        if (!imagesArr.length) return;
        current = (idx + imagesArr.length) % imagesArr.length;
        lbImg.src = imagesArr[current];
        lb.classList.add('open');
        lb.setAttribute('aria-hidden','false');
      }
      function close(){ lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); }
      function next(){ show(current+1); }
      function prev(){ show(current-1); }

      imgEl.addEventListener('click', ()=> show(current));
      lbClose.addEventListener('click', close);
      lb.addEventListener('click', (e)=>{ if (e.target === lb) close(); });
      lbNext.addEventListener('click', next);
      lbPrev.addEventListener('click', prev);
      document.addEventListener('keydown', (e)=>{
        if (!lb.classList.contains('open')) return;
        if (e.key === 'Escape') close();
        if (e.key === 'ArrowRight') next();
        if (e.key === 'ArrowLeft') prev();
      });
    })();

  </script>
  </body>
  </html>
